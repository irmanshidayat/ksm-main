# =============================================================================
# KSM MAIN - DOCKER COMPOSE CONFIGURATION (DEVELOPMENT ONLY)
# =============================================================================
#
# CATATAN PENTING:
# ================
# File ini HANYA untuk DEVELOPMENT deployment menggunakan Docker.
# 
# Untuk DEVELOPMENT:
# - Gunakan docker-compose -f docker-compose.dev.yml up untuk menjalankan semua service
# - Pastikan file .env sudah dikonfigurasi dengan benar (gunakan env.dev.example sebagai template)
# - Domain: https://devreport.ptkiansantang.com
# - Database: ksm_main_dev
# - Port berbeda dengan production untuk menghindari konflik
#
# Untuk PRODUCTION:
# - Gunakan docker-compose.yml (file terpisah)
# - Domain: https://report.ptkiansantang.com
# - Database: KSM_main
#
# =============================================================================

services:
  # MySQL Database untuk Development
  # Port mapping: 3310 (host) -> 3306 (container)
  # - Host port 3310: untuk akses dari luar container (jika diperlukan)
  # - Container port 3306: port internal MySQL di dalam container
  # - Aplikasi di dalam Docker network menggunakan mysql-dev:3306
  mysql-dev:
    image: mysql:8.0
    container_name: KSM-mysql-dev
    restart: always
    environment:
      # Default password untuk Docker: admin123 (jika DB_PASSWORD tidak ter-set di .env)
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-admin123}
      MYSQL_DATABASE: ksm_main_dev
    volumes:
      - mysql_dev_data:/var/lib/mysql
      - ./infrastructure/mysql-init:/docker-entrypoint-initdb.d
      - ./logs/mysql-dev:/var/log/mysql
    ports:
      - "3310:3306"  # External port 3310, internal port 3306
    networks:
      - KSM-dev-network
    command: --default-authentication-plugin=mysql_native_password --general-log=1 --general-log-file=/var/log/mysql/mysql.log
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Redis Cache untuk Development
  redis-dev:
    image: redis:7-alpine
    container_name: KSM-redis-dev
    restart: always
    ports:
      - "6381:6379"
    volumes:
      - redis_dev_data:/data
      - ./infrastructure/redis/redis.dev.conf:/usr/local/etc/redis/redis.conf
      - ./logs/redis-dev:/var/log/redis
    networks:
      - KSM-dev-network
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 10s
      retries: 5
    # Jika menggunakan Redis password, uncomment baris berikut:
    # command: redis-server /usr/local/etc/redis/redis.conf --requirepass ${REDIS_PASSWORD} --appendonly yes --logfile /var/log/redis/redis.log

  # Qdrant Vector Database untuk Development
  qdrant-dev:
    image: qdrant/qdrant:latest
    container_name: KSM-qdrant-dev
    restart: always
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_dev_data:/qdrant/storage
      - ./logs/qdrant-dev:/qdrant/logs
    networks:
      - KSM-dev-network
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:6333/health || wget --spider --quiet http://localhost:6333/ || exit 1"]
      timeout: 10s
      retries: 5
      interval: 30s
      start_period: 30s

  # Agent AI Service untuk Development
  agent-ai-dev:
    build:
      context: ../Agent AI
      dockerfile: Dockerfile.production
      args:
        BUILDKIT_INLINE_CACHE: 1
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    container_name: KSM-agent-ai-dev
    restart: always
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - KSM_API_KEY=${KSM_API_KEY:-}
      - NGROK_AUTH_TOKEN=${NGROK_AUTH_TOKEN:-}
      - DB_HOST=mysql-dev
      - DB_PORT=3306
      - DB_NAME=ksm_main_dev
      - DB_USER=${DB_USER:-root}
      # Default password untuk Docker: admin123 (jika DB_PASSWORD tidak ter-set di .env)
      - DB_PASSWORD=${DB_PASSWORD:-admin123}
      - DATABASE_URL=mysql+pymysql://${DB_USER:-root}:${DB_PASSWORD:-admin123}@mysql-dev:3306/ksm_main_dev
      - REDIS_URL=redis://redis-dev:6379/0
      # Jika menggunakan Redis password, ubah menjadi: redis://:${REDIS_PASSWORD}@redis-dev:6379/0
    ports:
      - "5002:5000"
    depends_on:
      mysql-dev:
        condition: service_healthy
      redis-dev:
        condition: service_healthy
    networks:
      - KSM-dev-network
    volumes:
      - agent_ai_dev_logs:/app/logs
      - agent_ai_dev_data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      timeout: 10s
      retries: 5
      interval: 30s

  # KSM Main Backend untuk Development
  ksm-backend-dev:
    build:
      context: ./backend
      dockerfile: Dockerfile.production
      args:
        BUILDKIT_INLINE_CACHE: 1
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    container_name: KSM-backend-dev
    restart: always
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - DB_HOST=mysql-dev
      - DB_PORT=3306
      - DB_NAME=ksm_main_dev
      - DB_USER=${DB_USER:-root}
      # Default password untuk Docker: admin123 (jika DB_PASSWORD tidak ter-set di .env)
      - DB_PASSWORD=${DB_PASSWORD:-admin123}
      - DATABASE_URL=mysql+pymysql://${DB_USER:-root}:${DB_PASSWORD:-admin123}@mysql-dev:3306/ksm_main_dev
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-default-jwt-secret-key-change-in-production}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - KSM_API_KEY=${KSM_API_KEY:-}
      - REDIS_URL=redis://redis-dev:6379/0
      # Jika menggunakan Redis password, ubah menjadi: redis://:${REDIS_PASSWORD}@redis-dev:6379/0
      - AGENT_AI_URL=http://agent-ai-dev:5000
      - QDRANT_URL=http://qdrant-dev:6333
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - LOG_LEVEL=DEBUG
      # Set encryption key secara eksplisit untuk konsistensi
      - EMAIL_DOMAIN_ENCRYPTION_KEY=nGLXDhCPmhCx5WugGHstyCkT7RY7P066rE_PnN5Hcqk=
    ports:
      - "8002:8000"
    depends_on:
      mysql-dev:
        condition: service_healthy
      redis-dev:
        condition: service_healthy
      qdrant-dev:
        condition: service_healthy
      agent-ai-dev:
        condition: service_started
    networks:
      - KSM-dev-network
    volumes:
      - KSM_backend_dev_logs:/app/logs
      - KSM_backend_dev_data:/app/data
      - KSM_backend_dev_rag_documents:/app/rag_documents
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      timeout: 10s
      retries: 5
      interval: 30s

  # KSM Main Frontend untuk Development (CRA)
  # DISABLED: Folder frontend tidak ada, hanya menggunakan frontend-vite
  # ksm-frontend-dev:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile.production
  #     args:
  #       - REACT_APP_API_URL=http://localhost:8002
  #       - REACT_APP_ENVIRONMENT=development
  #   container_name: KSM-frontend-dev
  #   restart: always
  #   environment:
  #     - REACT_APP_API_URL=http://localhost:8002
  #     - REACT_APP_ENVIRONMENT=development
  #   ports:
  #     - "3003:3000"
  #   depends_on:
  #     - ksm-backend-dev
  #   networks:
  #     - KSM-dev-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:3000"]
  #     timeout: 10s
  #     retries: 5
  #     interval: 30s

  # KSM Main Frontend Vite untuk Development
  ksm-frontend-vite-dev:
    build:
      context: ./frontend-vite
      dockerfile: Dockerfile.production
      args:
        - VITE_APP_API_URL=http://localhost:8002
        - VITE_APP_ENVIRONMENT=development
    container_name: KSM-frontend-vite-dev
    restart: always
    environment:
      - VITE_APP_API_URL=http://localhost:8002
      - VITE_APP_ENVIRONMENT=development
    ports:
      - "3006:3000"
    depends_on:
      - ksm-backend-dev
    networks:
      - KSM-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      timeout: 10s
      retries: 5
      interval: 30s

  # Nginx Reverse Proxy untuk Development
  nginx-dev:
    image: nginx:alpine
    container_name: KSM-nginx-dev
    restart: always
    ports:
      - "8084:80"
      - "8444:443"
    volumes:
      - ./infrastructure/nginx/nginx.dev.conf:/etc/nginx/nginx.conf
      - ./infrastructure/nginx/ssl:/etc/nginx/ssl
      - ./logs/nginx-dev:/var/log/nginx
    depends_on:
      ksm-frontend-vite-dev:
        condition: service_started
      ksm-backend-dev:
        condition: service_started
      agent-ai-dev:
        condition: service_started
      adminer-dev:
        condition: service_started
    networks:
      - KSM-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      timeout: 10s
      retries: 5
      interval: 30s

  # Monitoring dengan Prometheus untuk Development
  prometheus-dev:
    image: prom/prometheus:latest
    container_name: KSM-prometheus-dev
    restart: always
    ports:
      - "9092:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_dev_data:/prometheus
    networks:
      - KSM-dev-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'

  # Monitoring dengan Grafana untuk Development
  grafana-dev:
    image: grafana/grafana:latest
    container_name: KSM-grafana-dev
    restart: always
    ports:
      - "3007:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana_dev_data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana:/etc/grafana/provisioning
    networks:
      - KSM-dev-network
    depends_on:
      - prometheus-dev

  # Adminer - Database Management Tool untuk MySQL Development
  # Akses via: http://localhost:8085 atau https://devreport.ptkiansantang.com/adminer
  # Login dengan:
  # - System: MySQL
  # - Server: mysql-dev
  # - Username: root (atau DB_USER dari .env)
  # - Password: (DB_PASSWORD dari .env)
  # - Database: ksm_main_dev
  adminer-dev:
    image: adminer:latest
    container_name: KSM-adminer-dev
    restart: always
    environment:
      ADMINER_DEFAULT_SERVER: mysql-dev
    ports:
      - "8085:8080"
    depends_on:
      mysql-dev:
        condition: service_healthy
    networks:
      - KSM-dev-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080"]
      timeout: 5s
      retries: 3
      interval: 10s

volumes:
  mysql_dev_data:
  redis_dev_data:
  qdrant_dev_data:
  agent_ai_dev_logs:
  agent_ai_dev_data:
  KSM_backend_dev_logs:
  KSM_backend_dev_data:
  KSM_backend_dev_rag_documents:
  prometheus_dev_data:
  grafana_dev_data:

networks:
  KSM-dev-network:
    driver: bridge

