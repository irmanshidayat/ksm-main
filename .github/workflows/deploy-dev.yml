# =============================================================================
# GitHub Actions - Deployment Development
# =============================================================================
# 
# Workflow untuk deployment otomatis ke development server
# Trigger: Push ke branch 'dev'
# 
# Requirements:
# - GitHub Secrets:
#   - SSH_HOST_DEV: IP/hostname server development
#   - SSH_USER_DEV: Username SSH untuk development
#   - SSH_KEY_DEV: Private SSH key untuk development
#   - DEPLOY_PATH_DEV: Path di server (default: /opt/ksm-main-dev)
# 
# Note: VPS menggunakan port SSH 22 (port default)
# =============================================================================

name: Deploy Development

on:
  push:
    branches:
      - dev
  workflow_dispatch: # Manual trigger

env:
  COMPOSE_FILE: docker-compose.dev.yml
  DEPLOY_ENV: development

jobs:
  deploy:
    name: Deploy to Development Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secrets
        run: |
          echo "üîç Validating required secrets..."
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.SSH_HOST_DEV }}" ]; then
            MISSING_SECRETS+=("SSH_HOST_DEV")
          fi
          
          if [ -z "${{ secrets.SSH_USER_DEV }}" ]; then
            MISSING_SECRETS+=("SSH_USER_DEV")
          fi
          
          if [ -z "${{ secrets.SSH_KEY_DEV }}" ]; then
            MISSING_SECRETS+=("SSH_KEY_DEV")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå ERROR: Required secrets are not set!"
            echo ""
            echo "Missing secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "üìù To fix this, please add the following secrets in GitHub:"
            echo "   1. Go to: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Add each secret:"
            echo ""
            echo "   Required secrets for Development:"
            echo "   - SSH_HOST_DEV: IP atau hostname server (contoh: 72.61.142.109)"
            echo "   - SSH_USER_DEV: Username SSH (contoh: root)"
            echo "   - SSH_KEY_DEV: Private SSH key (full key dengan header/footer)"
            echo "   - DEPLOY_PATH_DEV: (Optional) Path deployment (default: /opt/ksm-main-dev)"
            echo ""
            echo "   Example SSH_KEY_DEV format:"
            echo "   -----BEGIN OPENSSH PRIVATE KEY-----"
            echo "   ..."
            echo "   -----END OPENSSH PRIVATE KEY-----"
            echo ""
            exit 1
          fi
          
          echo "‚úÖ All required secrets are set!"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_DEV }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H -p 22 ${{ secrets.SSH_HOST_DEV }} >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è  Warning: ssh-keyscan failed, but continuing..."
            echo "This might be due to network issues or server unreachable."
          }
          chmod 600 ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          echo "üîê Testing SSH connection..."
          ssh -p 22 -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o BatchMode=yes \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} \
            "echo 'SSH connection successful'" || {
            echo ""
            echo "‚ùå ERROR: SSH connection failed!"
            echo ""
            echo "Possible causes:"
            echo "  1. SSH public key belum ditambahkan ke server's authorized_keys"
            echo "  2. Format SSH private key di GitHub Secrets salah"
            echo "  3. SSH key tidak match dengan public key di server"
            echo "  4. Server SSH configuration tidak mengizinkan key authentication"
            echo ""
            echo "üìù To fix this:"
            echo ""
            echo "Step 1: Generate SSH key (jika belum ada):"
            echo "  ssh-keygen -t ed25519 -C 'github-actions-deploy' -f ~/.ssh/github_actions_deploy"
            echo ""
            echo "Step 2: Copy public key ke server:"
            echo "  ssh-copy-id -i ~/.ssh/github_actions_deploy.pub -p 22 ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }}"
            echo ""
            echo "  Atau manual:"
            echo "  cat ~/.ssh/github_actions_deploy.pub | ssh -p 22 ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} \\"
            echo "    'mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys'"
            echo ""
            echo "Step 3: Test connection manually:"
            echo "  ssh -p 22 -i ~/.ssh/github_actions_deploy ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }}"
            echo ""
            echo "Step 4: Copy private key ke GitHub Secrets (SSH_KEY_DEV):"
            echo "  cat ~/.ssh/github_actions_deploy"
            echo ""
            echo "  Pastikan format lengkap dengan header dan footer:"
            echo "  -----BEGIN OPENSSH PRIVATE KEY-----"
            echo "  ..."
            echo "  -----END OPENSSH PRIVATE KEY-----"
            echo ""
            echo "Step 5: Verify server SSH config (di server):"
            echo "  sudo nano /etc/ssh/sshd_config"
            echo "  Pastikan:"
            echo "    - PubkeyAuthentication yes"
            echo "    - AuthorizedKeysFile .ssh/authorized_keys"
            echo "  Lalu restart: sudo systemctl restart sshd"
            echo ""
            exit 1
          }
          echo "‚úÖ SSH connection successful!"

      - name: Create deployment directory
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          ssh -p 22 ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} \
            "mkdir -p $DEPLOY_PATH"

      - name: Copy docker-compose file
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          scp -P 22 ksm-main/docker-compose.dev.yml \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }}:$DEPLOY_PATH/docker-compose.yml

      - name: Copy infrastructure files
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          ssh -p 22 ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} \
            "mkdir -p $DEPLOY_PATH/infrastructure"
          
          scp -P 22 -r ksm-main/infrastructure/* \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }}:$DEPLOY_PATH/infrastructure/

      - name: Copy backend files
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          ssh -p 22 ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} \
            "mkdir -p $DEPLOY_PATH/backend"
          
          rsync -avz -e "ssh -p 22" --exclude='__pycache__' --exclude='*.pyc' --exclude='.venv' --exclude='ksm_venv' \
            ksm-main/backend/ \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }}:$DEPLOY_PATH/backend/

      - name: Copy frontend-vite files
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          ssh -p 22 ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} \
            "mkdir -p $DEPLOY_PATH/frontend-vite"
          
          rsync -avz -e "ssh -p 22" --exclude='node_modules' --exclude='dist' --exclude='.next' \
            ksm-main/frontend-vite/ \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }}:$DEPLOY_PATH/frontend-vite/

      - name: Copy Agent AI files
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          ssh -p 22 ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} \
            "mkdir -p $DEPLOY_PATH/../Agent AI"
          
          rsync -avz -e "ssh -p 22" --exclude='__pycache__' --exclude='*.pyc' --exclude='.venv' --exclude='agent_venv' \
            "Agent AI/" \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }}:$DEPLOY_PATH/../Agent\ AI/

      - name: Create logs directory
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          ssh -p 22 ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} \
            "mkdir -p $DEPLOY_PATH/logs/{mysql-dev,nginx-dev,redis-dev}"

      - name: Deploy with Docker Compose
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          ssh -p 22 -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} << DEPLOY_EOF || {
            echo "‚ùå SSH command failed with exit code $?"
            echo "Checking SSH connection..."
            ssh -p 22 -o ConnectTimeout=10 -v ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} "echo 'SSH test'" || true
            exit 1
          }
            set -e
            set -o pipefail
            
            # Error handling
            trap 'EXIT_CODE=\$?; echo "‚ùå Error at line \$LINENO: Command failed with exit code \$EXIT_CODE"; exit \$EXIT_CODE' ERR
            
            # Debug info
            echo "üìÅ Current directory: \$(pwd)"
            echo "üìÅ Deploy path: $DEPLOY_PATH"
            echo "üîç Checking deployment directory..."
            
            # Verify deployment directory exists
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "‚ùå ERROR: Deployment directory does not exist: $DEPLOY_PATH"
              echo "Creating directory..."
              mkdir -p "$DEPLOY_PATH" || {
                echo "‚ùå Failed to create directory"
                exit 1
              }
            fi
            
            cd "$DEPLOY_PATH" || {
              echo "‚ùå ERROR: Cannot change to directory: $DEPLOY_PATH"
              echo "Directory contents:"
              ls -la "$DEPLOY_PATH" || true
              exit 1
            }
            
            echo "‚úÖ Changed to deployment directory: \$(pwd)"
            echo "üìã Directory contents:"
            ls -la | head -20 || true
            
            # Stop existing containers
            echo "üõë Stopping existing containers..."
            if [ -f docker-compose.yml ]; then
              docker-compose -f docker-compose.yml down || true
            else
              echo "‚ö†Ô∏è  docker-compose.yml not found, skipping stop"
            fi
            
            # Check if .env file exists
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è  Warning: .env file not found. Creating from example..."
              if [ -f env.dev.example ]; then
                cp env.dev.example .env
                echo "‚úÖ Created .env from env.dev.example"
              else
                echo "‚ö†Ô∏è  env.dev.example not found. Services may fail without proper configuration."
              fi
            fi
            
            # Build and start services
            echo "üî® Building Docker images..."
            
            # Solusi 1: Build dengan cache (lebih cepat) - uncomment untuk menggunakan
            # docker-compose -f docker-compose.yml build || {
            #   echo "‚ùå Build failed! Showing logs..."
            #   docker-compose -f docker-compose.yml logs --tail=50
            #   exit 1
            # }
            
            # Solusi 2: Build dengan retry dan timeout yang lebih baik
            MAX_BUILD_RETRIES=3
            BUILD_RETRY=0
            BUILD_SUCCESS=false
            
            while [ \$BUILD_RETRY -lt \$MAX_BUILD_RETRIES ] && [ "\$BUILD_SUCCESS" = "false" ]; do
              BUILD_RETRY=\$((BUILD_RETRY + 1))
              echo "üîÑ Build attempt \$BUILD_RETRY/\$MAX_BUILD_RETRIES..."
              
              # Build dengan timeout per service untuk menghindari hang
              if DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1 \
                 timeout 1800 docker-compose -f docker-compose.yml build --parallel --progress=plain 2>&1 | tee /tmp/build.log; then
                BUILD_SUCCESS=true
                echo "‚úÖ Build successful!"
              else
                BUILD_EXIT_CODE=\${PIPESTATUS[0]}
                if [ \$BUILD_EXIT_CODE -eq 124 ]; then
                  echo "‚è±Ô∏è  Build timeout (30 minutes). Retrying..."
                else
                  echo "‚ùå Build failed with exit code \$BUILD_EXIT_CODE"
                  echo "üìã Last 50 lines of build log:"
                  tail -50 /tmp/build.log || true
                  
                  if [ \$BUILD_RETRY -lt \$MAX_BUILD_RETRIES ]; then
                    echo "üîÑ Retrying in 10 seconds..."
                    sleep 10
                  else
                    echo "‚ùå All build attempts failed!"
                    docker-compose -f docker-compose.yml logs --tail=50 || true
                    exit 1
                  fi
                fi
              fi
            done
            
            if [ "\$BUILD_SUCCESS" = "false" ]; then
              echo "‚ùå Build failed after \$MAX_BUILD_RETRIES attempts!"
              exit 1
            fi
            
            # Start services
            echo "üöÄ Starting services..."
            docker-compose -f docker-compose.yml up -d || {
              echo "‚ùå Failed to start services! Showing logs..."
              docker-compose -f docker-compose.yml logs --tail=50
              exit 1
            }
            
            # Wait for services to be healthy
            echo "‚è≥ Waiting for services to start (60 seconds)..."
            sleep 60
            
            # Check service status
            echo "üìä Service status:"
            docker-compose -f docker-compose.yml ps
            
            # Show any failed containers
            FAILED_CONTAINERS=\$(docker-compose -f docker-compose.yml ps | grep -E "(Exit|Restarting|unhealthy)" || true)
            if [ -n "\$FAILED_CONTAINERS" ]; then
              echo "‚ö†Ô∏è  Some containers have issues:"
              echo "\$FAILED_CONTAINERS"
              echo ""
              echo "üìã Showing logs for failed containers:"
              docker-compose -f docker-compose.yml logs --tail=100
            fi
            
            echo "‚úÖ Deployment script completed successfully"
          DEPLOY_EOF

      - name: Verify deployment
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_DEV || '/opt/ksm-main-dev' }}
        run: |
          ssh -p 22 -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} << VERIFY_EOF || {
            echo "‚ùå SSH verification failed with exit code $?"
            exit 1
          }
            set -e
            set -o pipefail
            
            # Error handling
            trap 'EXIT_CODE=\$?; echo "‚ùå Verification error at line \$LINENO: Command failed with exit code \$EXIT_CODE"; exit \$EXIT_CODE' ERR
            
            echo "üìÅ Verifying deployment at: $DEPLOY_PATH"
            
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "‚ùå ERROR: Deployment directory does not exist: $DEPLOY_PATH"
              exit 1
            fi
            
            cd "$DEPLOY_PATH" || {
              echo "‚ùå ERROR: Cannot change to directory: $DEPLOY_PATH"
              exit 1
            }
            
            # Get container status
            CONTAINER_STATUS=\$(docker-compose -f docker-compose.yml ps)
            echo "üìä Current container status:"
            echo "\$CONTAINER_STATUS"
            echo ""
            
            # Count running containers
            RUNNING_COUNT=\$(echo "\$CONTAINER_STATUS" | grep -c "Up" || echo "0")
            TOTAL_COUNT=\$(echo "\$CONTAINER_STATUS" | grep -v "NAME" | grep -v "^--" | wc -l || echo "0")
            
            echo "Running containers: \$RUNNING_COUNT / \$TOTAL_COUNT"
            echo ""
            
            # Check if containers are running
            if [ "\$RUNNING_COUNT" -gt 0 ]; then
              echo "‚úÖ Deployment successful! \$RUNNING_COUNT service(s) are running."
              echo ""
              echo "üìã Service details:"
              docker-compose -f docker-compose.yml ps
              
              # Show any non-running containers
              NON_RUNNING=\$(echo "\$CONTAINER_STATUS" | grep -v "Up" | grep -v "NAME" | grep -v "^--" || true)
              if [ -n "\$NON_RUNNING" ]; then
                echo ""
                echo "‚ö†Ô∏è  Some services are not running:"
                echo "\$NON_RUNNING"
                echo ""
                echo "üìã Logs for non-running services:"
                docker-compose -f docker-compose.yml logs --tail=50
              fi
            else
              echo "‚ùå Deployment failed! No services are running."
              echo ""
              echo "üìã All container status:"
              docker-compose -f docker-compose.yml ps
              echo ""
              echo "üìã Recent logs:"
              docker-compose -f docker-compose.yml logs --tail=100
              echo ""
              echo "üîç Checking for common issues:"
              echo "  - .env file: \$([ -f .env ] && echo '‚úÖ exists' || echo '‚ùå missing')"
              echo "  - Docker compose file: \$([ -f docker-compose.yml ] && echo '‚úÖ exists' || echo '‚ùå missing')"
              echo "  - Disk space:"
              df -h | head -2
              exit 1
            fi
            
            echo "‚úÖ Verification completed successfully"
          VERIFY_EOF

      - name: Cleanup old images
        if: success()
        run: |
          ssh -p 22 -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 \
            ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} << CLEANUP_EOF || {
            echo "‚ö†Ô∏è  Cleanup failed, but continuing..."
            exit 0
          }
            set +e  # Don't exit on error for cleanup
            
            echo "üßπ Cleaning up old Docker images..."
            
            # Remove dangling images
            docker image prune -f || true
            
            # Remove unused images (older than 7 days)
            docker image prune -a -f --filter "until=168h" || true
            
            echo "‚úÖ Cleanup completed"
          CLEANUP_EOF

